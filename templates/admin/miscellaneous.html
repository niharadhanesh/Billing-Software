{% extends 'admin/admin_dashboard.html' %}
{% block content %}


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    padding-top: 70px;
    background-color: #f8f9fa;
  }

  .navbar {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .panel {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  }

  .user-list li {
    cursor: pointer;
    padding: 8px 10px;
    border-bottom: 1px solid #eee;
  }

  .user-list li:last-child {
    border-bottom: none;
  }

  .user-list li.active-user,
  .user-list li:hover {
    background-color: #e9ecef;
  }

  .user-list-scroll {
    max-height: 300px; 
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    margin-bottom: 10px; 
  }

  @media (max-width: 1024px) {
    .top-buttons {
      margin-top: 50px !important;
    }
  }

  @media (max-width: 768px) {
    .top-buttons {
      margin-top: 0 !important;
    }
  }

  .custom-btn {
    width: 110px;
    height: 100px;
    padding: 12px 8px;
    line-height: 1.2;
    text-align: center;
    white-space: normal;
    word-wrap: break-word;
  }

  .settings-scroll-container {
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 5px;
  }

  .settings-scroll-container::-webkit-scrollbar {
    height: 6px;
  }

  .settings-scroll-container::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
  }

  .settings-scroll-container .btn {
    min-width: 150px;
    text-align: center;
    white-space: normal;
    margin-right: 2px;
    border-radius: 0;
    border: 1px solid #dee2e6;
    background-color: #f8f9fa;
    color: #495057;
    transition: 0.2s ease-in-out;
  }

  /* .settings-scroll-container .btn.active-setting {
    background-color: #FFAA17;
    color: white;
    font-weight: 500;
    z-index: 1;
  } */

  .card {
    border-radius: 10px;
    background-color: #fff;
    margin-bottom: 50px;
  }
  .modal-backdrop {
  opacity: 0.2 !important; 
}
</style>


<div class="container">
  <div class="d-flex justify-content-start mb-3 top-buttons gap-2">
     <a href="#" class="btn btn-outline-primary custom-btn text-center" data-bs-toggle="modal" data-bs-target="#quickWizardModal">
  <i class="fas fa-play fa-lg mb-1"></i><br>
  Quick Start<br>Wizard
</a>

    <a href="#" class="btn btn-outline-primary custom-btn text-center">
      <i class="fas fa-book fa-lg mb-1"></i><br>
      Online<br>User Manual
    </a>
    <a href="#" class="btn btn-outline-primary custom-btn text-center">
      <i class="fas fa-circle-up fa-lg mb-1"></i><br>
      Upgrade to<br>PRO Now
    </a>
  </div>

  <div class="card shadow-sm p-3">
    <div class="settings-scroll-container mb-3 border-bottom pb-2">
      <div class="d-flex flex-nowrap gap-1" id="settingTabs">
        <button class="btn flex-shrink-0" onclick="showSection(this, 'misc')">Miscellaneous</button>
        <a href="{% url 'company_settings' %}" class="btn btn-light flex-shrink-0">Company Settings</a>
        <a href="{% url 'invoice_settings' %}?section=invoice" class="btn btn-light flex-shrink-0">Invoice Settings</a>
        <a href="{% url 'order_settings' %}?section=order" class="btn btn-light flex-shrink-0">Order Settings</a>
        <a href="{% url 'estimate_settings' %}?section=estimate" class="btn btn-light flex-shrink-0">Estimate Settings</a>
        <a href="{% url 'admin_settings' %}#admin" class="btn flex-shrink-0">Administrator Panel</a>
        <a href="{% url 'advanced_settings' %}" class="btn btn-light flex-shrink-0">Advanced Settings</a>
         <a href="{% url 'email_templates' %}" class="btn btn-light flex-shrink-0">Email Templates</a>
        <a href="{% url 'payment_settings_view' %}" class="btn btn-light flex-shrink-0">Payments</a>
        <a href="{% url 'purchase_order' %}?section=purchase" class="btn btn-light flex-shrink-0">Purchase Order</a>
      </div>
    </div>

<div id="settingsContent" class="mt-3">
<!-- Miscellaneous Settings -->
<div id="MiscSettingsContent" style="display: none;">
  <div class="container-fluid">
    <form id="miscSettingsForm">
    <div class="row">
      <!-- Left Column -->
      <div class="col-sm-12 col-md-6">
        <!-- Menu and Window Color Style -->
        <h5>Menu and Window Color Style</h5>
        <select class="form-select mb-4" id="colorThemeSelector" onchange="changeDashboardTheme()">
          <option value="win7" {% if misc.menu_color == "win7" or not misc.menu_color %}selected{% endif %}>Select (Default White)</option>
          <option value="blue" {% if misc.menu_color == "blue" %}selected{% endif %}>Office 2003 Blue</option>
          <option value="classic" {% if misc.menu_color == "classic" %}selected{% endif %}>Office 2003 Classic</option>
          <option value="olive" {% if misc.menu_color == "olive" %}selected{% endif %}>Office 2003 Olive</option>
          <option value="silver" {% if misc.menu_color == "silver" %}selected{% endif %}>Office 2003 Silver</option>
          <option value="lune" {% if misc.menu_color == "lune" %}selected{% endif %}>Office 2007 Luna</option>
        </select>

        <!-- Extra Cost List Section -->
        <h5>Extra Cost List</h5>
        <div class="row">
          <div class="col-sm-12 col-md-8">
            <!-- Scrollable table wrapper -->
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-bordered w-100">
                <thead>
                  <tr class="text-center">
                    <th>Extra Cost Name</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in costs %}
                    <tr class="selectable-row" onclick="selectCost(this, '{{ i.id }}', '{{ i.cost_name }}')">
                      <td>{{ i.cost_name }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="col-sm-12 col-md-4 mt-3 mt-md-0">
            <div class="d-flex flex-column gap-2">
              <button class="btn btn-sm" style="background-color: #FFAA17; color: white;" data-bs-toggle="modal" data-bs-target="#addExtraCostModal">Add New Line</button>
              <button class="btn btn-secondary btn-sm" onclick="openEditModal()">Edit Line</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSelectedCost()">Delete Line</button>
            </div>
          </div>
        </div>

        <!-- Predefined Header/Footer Texts Section -->
        <h5 class="mt-4">Predefined Header/Footer Texts</h5>
        <div class="row">
          <div class="col-sm-12 col-md-8">
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-bordered w-100">
                <thead>
                  <tr class="text-center"><th>Header/Footer Text</th></tr>
                </thead>
                <tbody>
                  {% for i in texts %}
                  <tr class="selectable-headerfooter-row" onclick="selectHeaderFooter(this, '{{ i.id }}', '{{ i.predefined_text }}')">
                    <td>{{ i.predefined_text }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="col-sm-12 col-md-4 mt-3 mt-md-0">
            <div class="d-flex flex-column gap-2">
              <button class="btn btn-sm" style="background-color: #FFAA17;color: white;" data-bs-toggle="modal" data-bs-target="#addHeaderFooterModal">Add Line</button>
              <button class="btn btn-secondary btn-sm" onclick="openEditHeaderFooterModal()">Edit Line</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSelectedHeaderFooter()">Delete Line</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-sm-12 col-md-6 mt-4 mt-md-0">
        <!-- Change Login Password -->
        <!-- <h5>Change Login Password</h5>
          <form id="changePasswordForm" method="post">
            <div class="mb-3 row">
              <label class="col-sm-5 col-form-label">Old Password:</label>
              <div class="col-sm-7">
                <input type="password" class="form-control" id="oldPassword" name="old_password" oninput="validateOldPassword()" />
                <small id="oldPasswordMsg" class="text-danger"></small>
              </div>
            </div>
            <div class="mb-3 row">
              <label class="col-sm-5 col-form-label">New Password:</label>
              <div class="col-sm-7">
                <input type="password" class="form-control" id="newPassword" name="new_password" oninput="validateNewPassword()" />
                <small id="newPasswordMsg" class="text-danger"></small>
              </div>
            </div>
            <div class="mb-3 row">
              <label class="col-sm-5 col-form-label">Confirm Password:</label>
              <div class="col-sm-7">
                <input type="password" class="form-control" id="confirmPassword" name="confirm_password" oninput="checkPasswordMatch()" />
                <small id="confirmPasswordMsg" class="text-danger"></small>
              </div>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-sm btn-primary"  id="changePasswordBtn">Update Password</button>
            </div>
          </form> -->

        <!-- Terms of Payment -->
        <h5 class="mt-4">Terms of Payment</h5>
        <div class="row">
          <div class="col-sm-12 col-md-8">
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-bordered w-100">
                <thead>
                  <tr class="text-center">
                    <th>Terms of Payment</th>
                    <th>Date Shift (Days)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in terms%}
                  <tr class="selectable-term-row" onclick="selectTerm(this, '{{ i.id }}', '{{ i.term_name }}', '{{ i.days }}')">
                    <td>{{ i.term_name }}</td>
                    <td>{{ i.days }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="col-sm-12 col-md-4 mt-3 mt-md-0">
            <div class="d-flex flex-column gap-2">
              <button class="btn btn-sm" style="background-color: #FFAA17;color: white;" data-bs-toggle="modal" data-bs-target="#addTermsModal">Add Line</button>
              <button class="btn btn-secondary btn-sm" onclick="openEditTermsModal()">Edit Line</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSelectedTerm()">Delete Line</button>
            </div>
          </div>
        </div>

        <!-- Email Attachment File Type -->
        <h5 class="mt-4">Email Attachment File Type</h5>
            <p class="text-muted small">
            Choose the default file format for email attachments of invoices, estimates, and purchase orders.
            </p>
            <div class="d-flex flex-column flex-md-row gap-3">
            <div class="form-check">
            <input class="form-check-input" type="radio" name="attachment_type" value="pdf" id="formatPdf"
                    {% if misc.attachment_type == "pdf" %}checked{% endif %}>
              <label class="form-check-label" for="formatPdf">PDF (Selected by default)</label>
                        </div>
                        <div class="form-check">
            <input class="form-check-input" type="radio" name="attachment_type" value="html" id="formatHtml"
                    {% if misc.attachment_type == "html" %}checked{% endif %}>
              <label class="form-check-label" for="formatHtml">HTML</label>
            </div>
            </div>


        <!-- Checkbox Options -->
        <h5 class="mt-4">Checkbox Options</h5>
        <p class="text-muted small">Reflected in respective modules:</p>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="invoice_numbering" id="invoiceLeadingZeros"
                  {% if misc.invoice_numbering %}checked{% endif %}>
            <label class="form-check-label" for="invoiceLeadingZeros">Invoice numbering with leading zeros</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="order_numbering" id="orderLeadingZeros"
                  {% if misc.order_numbering %}checked{% endif %}>
            <label class="form-check-label" for="orderLeadingZeros">Order numbering with leading zeros</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="estimate_numbering" id="estimateLeadingZeros"
                  {% if misc.estimate_numbering %}checked{% endif %}>
            <label class="form-check-label" for="estimateLeadingZeros">Estimate numbering with leading zeros</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="porder_numbering" id="purchaseOrderLeadingZeros"
                  {% if misc.porder_numbering %}checked{% endif %}>
            <label class="form-check-label" for="purchaseOrderLeadingZeros">Purchase order numbering with leading zeros</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="confirmation" id="confirmBeforeLogout"
                  {% if misc.confirmation %}checked{% endif %}>
            <label class="form-check-label" for="confirmBeforeLogout">Confirm before logout</label>
          </div>
              <!-- Save Button -->
      <div class="text-end mt-4">
      <button type="button" class="btn btn-success btn-sm" id="saveMiscSettingsBtn">Save Settings</button>   
   </div>
    </form>
      </div>
    </div>
  </div>
</div>


<!-- Add Extra Cost Modal -->
<div class="modal fade" id="addExtraCostModal" tabindex="-1" aria-labelledby="addExtraCostModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #FFAA17;color: white;">
        <h5 class="modal-title" id="addExtraCostModalLabel">Add Extra Cost</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="extraCostForm" action="{% url 'add_new_cost' %}" method="post">
            {% csrf_token %}
          <div class="mb-3">
            <label for="extraCostName" class="form-label">Enter Cost Name:</label>
            <input type="text" class="form-control" id="extraCostName" name="extraCostName" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-sm" form="extraCostForm" style="background-color: #FFAA17;color: white;">Save</button>
      </div>
    </div>
  </div>
</div>




<!-- Edit Extra Cost Modal -->
<div class="modal fade" id="editaddExtraCostModal" tabindex="-1" aria-labelledby="editaddExtraCostModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #FFAA17; color: white;">
        <h5 class="modal-title" id="editaddExtraCostModalLabel">Edit Extra Cost</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editExtraCostForm" action="" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="extraCostName" class="form-label">Enter Cost Name:</label>
            <input type="text" class="form-control" id="editExtraCostName" name="extraCostName">
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-sm" form="editExtraCostForm" style="background-color: #FFAA17; color: white;">Save</button>
      </div>

    </div>
  </div>
</div>



<!-- Add Header/Footer Text Modal -->
<div class="modal fade" id="addHeaderFooterModal" tabindex="-1" aria-labelledby="addHeaderFooterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #FFAA17;color: white;">
        <h5 class="modal-title" id="addHeaderFooterModalLabel">Add Header/Footer Text</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="headerFooterForm" action="{% url 'add_new_predefined_text' %}" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="headerFooterInput" class="form-label">Enter Text:</label>
            <input type="text" class="form-control" id="headerFooterInput" name="headerFooterInput" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn bbtn-sm" form="headerFooterForm" style="background-color: #FFAA17;color: white;">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- Edit Header/Footer Text Modal -->
<div class="modal fade" id="editHeaderFooterModal" tabindex="-1" aria-labelledby="editHeaderFooterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #FFAA17;color: white;">
        <h5 class="modal-title" id="addHeaderFooterModalLabel">Add Header/Footer Text</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="headerFooterEditForm" action="" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="headerFooterInput" class="form-label">Enter Text:</label>
            <input type="text" class="form-control" id="headerFootertext" name="headerFootertext" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn bbtn-sm" form="headerFooterEditForm" style="background-color: #FFAA17;color: white;">Save</button>
      </div>
    </div>
  </div>
</div>



<!-- Terms of Payment Modal -->
<div class="modal fade" id="addTermsModal" tabindex="-1" aria-labelledby="addTermsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    
      <div class="modal-header" style="background-color: #FFAA17;color: white;">
        <h5 class="modal-title" id="addTermsModalLabel">Add Terms of Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <form id="termsForm" action="{% url 'add_new_payment_terms' %}" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="termsName" class="form-label">Terms of Payment</label>
            <input type="text" class="form-control" id="termsName" name="termsName" required>
          </div>
          <div class="mb-3">
            <label for="shiftDays" class="form-label">Days of Shift</label>
            <input type="number" class="form-control" id="shiftDays" name="shiftDays" min="0" required>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn  btn-sm" form="termsForm" style="background-color: #FFAA17;color: white;">Save</button>
      </div>
      
    </div>
  </div>
</div>


<!-- Edit Terms of Payment Modal -->
<div class="modal fade" id="editTermsModal" tabindex="-1" aria-labelledby="editTermsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    
      <div class="modal-header" style="background-color: #FFAA17;color: white;">
        <h5 class="modal-title" id="addTermsModalLabel">Add Terms of Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <form id="termsEditForm" action="" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="termsName" class="form-label">Terms of Payment</label>
            <input type="text" class="form-control" id="termsEditName" name="termsEditName" required>
          </div>
          <div class="mb-3">
            <label for="shiftDays" class="form-label">Days of Shift</label>
            <input type="number" class="form-control" id="shiftEditDays" name="shitfEditDays" min="0" required>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn  btn-sm" form="termsEditForm" style="background-color: #FFAA17;color: white;">Save</button>
      </div>
      
    </div>
  </div>
</div>



  <div id="CompanySettingsContent" style="display: none;">
 </div>
  <div id="InvoiceSettingsContent" style="display: none;">
    <p>Invoice Settings</p>
  </div>

  <div id="OrderSettingsContent" style="display: none;">
    <p>Order Settings</p>
  </div>

  <div id="EstimateSettingsContent" style="display: none;">
    <p>Estimate Settings</p>
  </div>



  <div id="EmailSettingsContent" style="display: none;">
    <p>Email Templates</p>
  </div>

  <div id="PaymentsSettingsContent" style="display: none;">
    <p>Payments Settings</p>
  </div>

  <div id="PurchaseSettingsContent" style="display: none;">
    <p>Purchase Order Settings</p>
  </div>
</div>

</div>


<!-- JS: Show Sections -->
<script>
  function showSection(button, section) {
    document.querySelectorAll('#settingTabs button').forEach(btn =>
      btn.classList.remove('active-setting')
    );
    button.classList.add('active-setting');

    const allSections = [
      'MiscSettingsContent',
      'CompanySettingsContent',
      'InvoiceSettingsContent',
      'OrderSettingsContent',
      'EstimateSettingsContent',
      'AdvancedSettingsContent',
      'EmailSettingsContent',
      'PaymentsSettingsContent',
      'PurchaseSettingsContent'
    ];

    allSections.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });

    const sectionId = section.charAt(0).toUpperCase() + section.slice(1) + 'SettingsContent';
    const currentSection = document.getElementById(sectionId);
    if (currentSection) currentSection.style.display = 'block';
  }

  window.addEventListener('DOMContentLoaded', () => {
    const defaultButton = document.querySelector('#settingTabs button:nth-child(1)'); 
    if (defaultButton) {
      showSection(defaultButton, 'misc');
    }
  });
</script>


<script>
  let selectedCostId = null;
  let selectedCostName = '';

  function selectCost(row, costId, costName) {
    document.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('table-active'));

    row.classList.add('table-active');

    selectedCostId = costId;
    selectedCostName = costName;

    console.log("Selected:", selectedCostId, selectedCostName);
  }

  function openEditModal() {
    if (!selectedCostId) {
      alert("Please select a cost to edit.");
      return;
    }

    const modalEl = document.getElementById("editaddExtraCostModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    modalEl.addEventListener('shown.bs.modal', function handler() {
      const input = document.getElementById("editExtraCostName");
      input.value = selectedCostName;

      const form = document.getElementById("editExtraCostForm");
      form.action = `/edit_cost/${selectedCostId}/`;

      console.log("Input set to:", input.value);

      modalEl.removeEventListener('shown.bs.modal', handler);
    });
  }

  function deleteSelectedCost() {
    if (!selectedCostId) {
      alert("Please select a cost to delete.");
      return;
    }

    if (!confirm(`Are you sure you want to delete this cost"${selectedCostName}"?`)) {
      return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/delete_cost/${selectedCostId}/`;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      const csrfClone = csrfToken.cloneNode();
      form.appendChild(csrfClone);
    }

    document.body.appendChild(form);
    form.submit();
  }
</script>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("dashboardTheme") || "win7";
    const body = document.body;
    const select = document.getElementById("colorThemeSelector");

    body.classList.remove("theme-blue", "theme-classic", "theme-olive", "theme-silver", "theme-luna", "theme-win7");

    body.classList.add("theme-" + savedTheme);

    if (select) {
      select.value = savedTheme;
    }
  });

  function changeDashboardTheme() {
    const selectedTheme = document.getElementById("colorThemeSelector").value;
    const body = document.body;

    body.classList.remove("theme-blue", "theme-classic", "theme-olive", "theme-silver", "theme-luna", "theme-win7");

    body.classList.add("theme-" + selectedTheme);
    localStorage.setItem("dashboardTheme", selectedTheme);
  }
</script>




<script>
  let selectedHeaderFooterId = null;
  let selectedHeaderFooterText = '';

  function selectHeaderFooter(row, id, text) {
    document.querySelectorAll('.selectable-headerfooter-row').forEach(r => r.classList.remove('table-active'));
    row.classList.add('table-active');

    selectedHeaderFooterId = id;
    selectedHeaderFooterText = text;
    console.log("Selected:", selectedHeaderFooterId, selectedHeaderFooterText);
  }

  function openEditHeaderFooterModal() {
    if (!selectedHeaderFooterId) {
      alert("Please select a header/footer text to edit.");
      return;
    }

    const modalEl = document.getElementById("editHeaderFooterModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    modalEl.addEventListener('shown.bs.modal', function handler() {
      document.getElementById("headerFootertext").value = selectedHeaderFooterText;
      const form = document.getElementById("headerFooterEditForm");
      form.action = `/edit_header_footer/${selectedHeaderFooterId}/`;

      modalEl.removeEventListener('shown.bs.modal', handler);
    });
  }

  function deleteSelectedHeaderFooter() {
    if (!selectedHeaderFooterId) {
      alert("Please select a header/footer text to delete.");
      return;
    }

    if (confirm("Are you sure you want to delete this entry?")) {
      window.location.href = `/delete_header_footer/${selectedHeaderFooterId}/`;
    }
  }
</script>


<script>
let isOldPasswordValid = false;

function getCSRFToken() {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.substring(0, 10) === "csrftoken=") {
        cookieValue = decodeURIComponent(cookie.substring(10));
        break;
      }
    }
  }
  return cookieValue;
}

function formatErrors(errors) {
  if (typeof errors === 'string') return errors;
  if (typeof errors === 'object') {
    let messages = [];
    for (const field in errors) {
      if (Array.isArray(errors[field])) {
        messages.push(...errors[field]);
      } else {
        messages.push(`${field}: ${errors[field]}`);
      }
    }
    return [...new Set(messages)].join('\n');
  }
  return "Unknown error occurred.";
}

function validateOldPassword() {
  const oldPass = document.getElementById("oldPassword").value;
  const msg = document.getElementById("oldPasswordMsg");

  if (oldPass.trim().length < 1) {
    msg.textContent = "Enter your current password";
    msg.classList.remove("text-success");
    msg.classList.add("text-danger");
    isOldPasswordValid = false;
    return;
  }

  fetch("{% url 'validate_old_password' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({ password: oldPass })
  })
    .then(res => res.json())
    .then(data => {
      isOldPasswordValid = data.valid;
      msg.textContent = isOldPasswordValid ? "✓ Password correct" : "✗ Incorrect password";
      msg.classList.toggle("text-success", isOldPasswordValid);
      msg.classList.toggle("text-danger", !isOldPasswordValid);
    })
    .catch(() => {
      msg.textContent = "Error validating password.";
      msg.classList.add("text-danger");
      isOldPasswordValid = false;
    });
}

document.getElementById("oldPassword").addEventListener("blur", validateOldPassword);
document.getElementById("oldPassword").addEventListener("input", () => {
  document.getElementById("oldPasswordMsg").textContent = "";
  isOldPasswordValid = false;
});

function validateNewPassword() {
  const newPass = document.getElementById("newPassword").value;
  const msg = document.getElementById("newPasswordMsg");
  const regex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*])(?=.{8,})/;

  if (newPass.trim() === "") {
    msg.textContent = "New password cannot be empty";
    msg.classList.add("text-danger");
    return false;
  }

  if (!regex.test(newPass)) {
    msg.textContent = "Must be 8+ chars & contain: 1 uppercase, 1 number, 1 special";
    msg.classList.add("text-danger");
    return false;
  }

  msg.textContent = "✓ Password meets strength requirements";
  msg.classList.remove("text-danger");
  msg.classList.add("text-success");
  return true;
}
document.getElementById("newPassword").addEventListener("input", validateNewPassword);

function checkPasswordMatch() {
  const newPass = document.getElementById("newPassword").value;
  const confirmPass = document.getElementById("confirmPassword").value;
  const msg = document.getElementById("confirmPasswordMsg");

  if (confirmPass.trim() === "") {
    msg.textContent = "Confirm password cannot be empty";
    msg.classList.add("text-danger");
    return false;
  }

  if (newPass !== confirmPass) {
    msg.textContent = "Passwords do not match";
    msg.classList.add("text-danger");
    return false;
  }

  msg.textContent = "✓ Passwords match";
  msg.classList.remove("text-danger");
  msg.classList.add("text-success");
  return true;
}
document.getElementById("confirmPassword").addEventListener("input", checkPasswordMatch);

document.getElementById("changePasswordBtn").addEventListener("click", function () {
  const oldPass = document.getElementById("oldPassword").value;
  const newPass = document.getElementById("newPassword").value;
  const confirmPass = document.getElementById("confirmPassword").value;

  if (!oldPass || !newPass || !confirmPass) {
    alert("All fields are required.");
    return;
  }

  if (!isOldPasswordValid) {
    alert("Current password is not validated.");
    return;
  }

  const isNewValid = validateNewPassword();
  const isMatch = checkPasswordMatch();

  if (!isNewValid || !isMatch) {
    alert("Fix new password errors before submitting.");
    return;
  }

  const btn = document.getElementById("changePasswordBtn");
  btn.disabled = true;
  btn.textContent = "Changing...";

  fetch("{% url 'change_password' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({
      old_password: oldPass,
      new_password: newPass,
      confirm_password: confirmPass
    })
  })
    .then(res => res.json().then(data => {
      if (!res.ok) throw new Error(data.error || "Server error");
      return data;
    }))
    .then(data => {
      btn.disabled = false;
      btn.textContent = "Change Password";
      if (data.success) {
        alert(data.message || "Password changed successfully! Redirecting...");
        window.location.href = "{% url 'Log_in' %}";
      } else {
        alert("Password change failed: " + formatErrors(data.error));
      }
    })
    .catch(error => {
      btn.disabled = false;
      btn.textContent = "Change Password";
      console.error("Password change error:", error);

      if (error.message.includes("CSRF") || error.message.includes("403")) {
        alert("Session expired or CSRF issue. Reloading...");
        window.location.reload();
      } else {
        alert("Error changing password: " + error.message);
      }
    });
});

document.addEventListener("DOMContentLoaded", function () {
  document.getElementById("oldPasswordMsg").textContent = "";
  document.getElementById("newPasswordMsg").textContent = "";
  document.getElementById("confirmPasswordMsg").textContent = "";
});
</script>


<script>
  let selectedTermId = null;
  let selectedTermName = '';
  let selectedTermDays = '';

  function selectTerm(row, termId, termName, termDays) {
    document.querySelectorAll('.selectable-term-row').forEach(r => r.classList.remove('table-active'));
    row.classList.add('table-active');

    selectedTermId = termId;
    selectedTermName = termName;
    selectedTermDays = termDays;

    console.log("Selected term:", selectedTermId, selectedTermName, selectedTermDays);
  }

  function openEditTermsModal() {
    if (!selectedTermId) {
      alert("Please select a term to edit.");
      return;
    }

    const modalEl = document.getElementById("editTermsModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    modalEl.addEventListener('shown.bs.modal', function handler() {
      document.getElementById("termsEditName").value = selectedTermName;
      document.getElementById("shiftEditDays").value = selectedTermDays;

      const form = document.getElementById("termsEditForm");
      form.action = `/edit_payment_term/${selectedTermId}/`;

      modalEl.removeEventListener('shown.bs.modal', handler);
    });
  }

  function deleteSelectedTerm() {
    if (!selectedTermId) {
      alert("Please select a term to delete.");
      return;
    }

    if (confirm(`Are you sure you want to delete: ${selectedTermName}?`)) {
      window.location.href = `/delete_payment_term/${selectedTermId}/`;
    }
  }
</script>


<script>
    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith('csrftoken=')) {
                return decodeURIComponent(cookie.substring('csrftoken='.length));
            }
        }
        return null; 
    }

    document.addEventListener('DOMContentLoaded', function() {
        const submitButton = document.getElementById('saveMiscSettingsBtn');

        if (submitButton) {
            submitButton.addEventListener('click', function (e) {
                e.preventDefault();

                const data = new FormData();

                const colorThemeSelector = document.getElementById('colorThemeSelector');
                if (colorThemeSelector) {
                    const menuColor = colorThemeSelector.value;
                    data.append('menu_color', menuColor || ''); 
                }

                const formatPdf = document.getElementById('formatPdf');
                const formatHtml = document.getElementById('formatHtml');

                if (formatPdf && formatPdf.checked) {
                    data.append('attachment_type', 'pdf');
                } else if (formatHtml && formatHtml.checked) {
                    data.append('attachment_type', 'html');
                } else {
                    data.append('attachment_type', 'pdf');
                }

                const invoiceLeadingZeros = document.getElementById('invoiceLeadingZeros');
                if (invoiceLeadingZeros && invoiceLeadingZeros.checked)
                    data.append('invoice_numbering', 'on');

                const orderLeadingZeros = document.getElementById('orderLeadingZeros');
                if (orderLeadingZeros && orderLeadingZeros.checked)
                    data.append('order_numbering', 'on');

                const estimateLeadingZeros = document.getElementById('estimateLeadingZeros');
                if (estimateLeadingZeros && estimateLeadingZeros.checked)
                    data.append('estimate_numbering', 'on');

                const purchaseOrderLeadingZeros = document.getElementById('purchaseOrderLeadingZeros');
                if (purchaseOrderLeadingZeros && purchaseOrderLeadingZeros.checked)
                    data.append('porder_numbering', 'on');

                const confirmBeforeLogout = document.getElementById('confirmBeforeLogout');
                if (confirmBeforeLogout && confirmBeforeLogout.checked)
                    data.append('confirmation', 'on');

                fetch("{{ update_misc_url }}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: data 
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => {
                            throw new Error(err.error || `HTTP error! Status: ${res.status}`);
                        }).catch(() => {
                            throw new Error(`HTTP error! Status: ${res.status} - Could not parse error message.`);
                        });
                    }
                    return res.json(); 
                })
                .then(result => {
                      if (result.success) {
                          alert(result.message);
                          location.reload(); 
                      } else {
                          alert("Error: " + result.error);
                      }
                  })

                .catch(error => {
                    console.error("JS Fetch Error:", error);
                    alert("An unexpected error occurred: " + error.message);
                });
            });
        } else {
            console.warn("Submit button with ID 'saveMiscSettingsBtn' not found. Ensure your HTML button has this ID.");
        }
    });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const miscForm = document.getElementById("miscSettingsForm");
    if (miscForm) {
      miscForm.addEventListener("submit", function (e) {
        e.preventDefault();
      });
    }
  });
</script>


{% endblock %}


{% block global_modals %}
  {% include 'includes/quick_start_modal.html' %}
{% endblock %}